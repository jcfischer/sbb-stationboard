{% assign station = trmnl.plugin_settings.custom_fields_values.station_name | default: "Zürich, Im Hagacker" %}
{% assign station_id = trmnl.plugin_settings.custom_fields_values.station_id | default: "8591209" %}
{% assign walkingTime = trmnl.plugin_settings.custom_fields_values.walking_time | plus: 0 %}
{% assign abbr_string = trmnl.plugin_settings.custom_fields_values.target_abbreviations | default: 0 %}
{% assign hidewords = trmnl.plugin_settings.custom_fields_values.target_hidewords | default: 0 %}
{% assign linetarget_filter = trmnl.plugin_settings.custom_fields_values.linetarget_filter | default: 0 %}
{% assign minDepartureOffset = trmnl.plugin_settings.custom_fields_values.min_departure_offset | default: 0 %}
{% assign transportHideGroups = trmnl.plugin_settings.custom_fields_values.transport_hidegroups | default: 0 %}
{% assign cablewayIcon = trmnl.plugin_settings.custom_fields_values.cableway_icon | default: "Gondel" %}

<div style="display:flex;flex-direction:column;height:100%;width:100%;">
  <div style="flex:1 1 auto;display:flex;flex-direction:column;width:100%;">
    <div style="width:100%;padding-left:8px;padding-right:8px;box-sizing:border-box;">
      <table class="table table--condensed table--compact" style="width:100%;margin:0;table-layout:fixed;">
        <thead>
          <tr>
            <!-- Spalte 1: Symbol (5% links) – Name nur im Code -->
            <th class="col-sym"><span class="sr-only">Symbol</span></th>
            <!-- Spalte 2: Liniennummer (7% links) – Name nur im Code -->
            <th class="col-lineno"><span class="sr-only">Liniennummer</span></th>
            <!-- Spalte 3: Linie (35% links) – sichtbar -->
            <th class="col-linie"><span class="title title--small">Linie</span></th>
            <!-- Spalte 4: Abfahrt (18% rechts) – sichtbar -->
            <th class="col-abfahrt"><span class="title title--small">Abfahrt</span></th>
            <!-- Spalte 5: Verspätung/Infos (15% rechts) – Name nur im Code -->
            <th class="col-delay"><span class="sr-only">Verspätung / Infos</span></th>
            <!-- Spalte 6: Los um (10% rechts) – sichtbar -->
            {% if walkingTime > 0 %}
            <th class="col-losum"><span class="title title--small">Los</span></th>
            {% endif %}
          </tr>
        </thead>
        <tbody id="departures-body">
          <tr>
            <td colspan="6"><span class="label label--small">Lade Daten…</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="title_bar" style="margin-top:auto;display:flex;align-items:center;justify-content:space-between;width:100%;">
    <div style="display:flex;align-items:center;">
      <img class="image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAAAAABXZoBIAAAAAXNSR0IArs4c6QAAAGBJREFUKJHd0EEOwCAIBMDd7f8/3MTQAwVRa3qXi8gYRIFjgu9qAGgA2JRVFfP0Mt8mFvOSdWzVPLXAW4N1ZV7wMSu3BlBb+m9bHjInqqNHxCFh1WwgLNq/S5h1+Mpj4gGrAxoVOFGx+gAAAABJRU5ErkJggg=="/>
    </div>
    <span class="instance" style="margin-left:auto;">{{ station }}</span>
    <span class="instance">{{ trmnl.system.timestamp_utc | plus: trmnl.user.utc_offset | date: "%d.%m.%y - %H:%M" }}</span>

  </div>
</div>

<!-- Layout-specific CSS -->
<style>
  :root { --gap-45: 10px; } /* Abstand zwischen Spalte 4 und 5 */

  /* Column widths for half vertical layout */
  .col-sym    { width:8%;  text-align:left; }
  .col-sym img { filter: grayscale(100%) contrast(200%) invert(1); }
  .col-lineno { width:10%; text-align:left; }
  {% if walkingTime > 0 %}
  .col-linie  { width:25%; text-align:left; }
  {% else %}
  .col-linie  { width:35%;  text-align:left; }
  {% endif %}
  .col-abfahrt{ width:15%; text-align:right; padding-right:0 !important; white-space:nowrap; }
  .col-delay  { width:20%; text-align:right; white-space:nowrap; padding-left:var(--gap-45); }
  .col-losum  { width:10%; text-align:right; padding-right:1px !important; white-space:nowrap; }
</style>

<script>
  /* -------- Liquid -> data-Attribute -------- */
  document.body.setAttribute('data-station', '{{ station }}');
  document.body.setAttribute('data-station_id', '{{ station_id }}');
  document.body.setAttribute('data-walkingtime', '{{ walkingTime }}');
  document.body.setAttribute('data-abbrs', `{{ abbr_string }}`);
  document.body.setAttribute('data-hidewords', `{{ hidewords }}`);
  document.body.setAttribute('data-linetargetfilter', `{{ linetarget_filter }}`);
  document.body.setAttribute('data-mindepartureoffset', '{{ minDepartureOffset }}');
  document.body.setAttribute('data-hidegroups', `{{ transportHideGroups }}`);
  document.body.setAttribute('data-cablewayicon', `{{ cablewayIcon }}`);

  /* -------- Inject stationboard data -------- */
  window.stationboardData = { stationboard: []};

  {% assign id_count = station_id | split: "," | size  | minus: 1 %}

  {% for i in (0..id_count) %}
  {% capture idx_key %}IDX_{{ i }}{% endcapture %}
  {% assign current_data = [idx_key] %}
  {% if current_data %}
  window.stationboardData.stationboard.push(...{{ current_data.stationboard | json }})
  {% endif %}
  {% endfor %}
  window.stationboardData.stationboard.sort((a,b) =>  a.stop['departure'] > b.stop['departure'])

  /* -------- Render with half vertical parameters -------- */
  renderDepartures(12, 'big');
</script>
